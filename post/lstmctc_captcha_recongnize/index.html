<html>
  <head>
    <meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>LSTM+CTCè¯†åˆ«å˜é•¿éªŒè¯ç ï¼ˆäººå·¥æ™ºèƒ½ç¬¬4æ¬¡è¯•éªŒï¼‰ | ä¸æƒ³é•¿å¤§çš„çŸ³å¤´</title>
<meta name="description" content="" />
<link rel="shortcut icon" href="https://jianhuchen-test.github.io//favicon.ico?v=1578661943877">
<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.7.2/css/all.css" integrity="sha384-fnmOCqbTlWIlj8LyTjo7mOUStjsKC4pOpQbqyi7RrhN7udi9RwhKkMHpvLbHG9Sr" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0/katex.min.css">
<link rel="stylesheet" href="https://jianhuchen-test.github.io//styles/main.css">

<script src="https://cdn.bootcss.com/highlight.js/9.12.0/highlight.min.js"></script>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Droid+Serif:400,700">



  </head>
  <body>
    <div class="main">
      <div class="main-content">
        <div class="site-header">
  <a href="https://jianhuchen-test.github.io/">
  <img class="avatar" src="https://jianhuchen-test.github.io//images/avatar.png?v=1578661943877" alt="">
  </a>
  <h1 class="site-title">
    ä¸æƒ³é•¿å¤§çš„çŸ³å¤´
  </h1>
  <p class="site-description">
    
  </p>
  <div class="menu-container">
    
      
        <a href="/" class="menu">
          ğŸŒˆé¦–é¡µ
        </a>
      
    
      
        <a href="/archives" class="menu">
          ğŸ“ƒ å½’æ¡£
        </a>
      
    
      
        <a href="/tags" class="menu">
          ğŸ· æ ‡ç­¾
        </a>
      
    
      
        <a href="/post/share/" class="menu">
          ğŸ‘ å…±äº«èµ„æº
        </a>
      
    
      
        <a href="/post/friends/" class="menu">
          ğŸ»å‹é“¾
        </a>
      
    
      
        <a href="/post/about/" class="menu">
          ğŸ‘¨â€ğŸ’» å…³äº &amp; ç•™è¨€
        </a>
      
    
  </div>
  <div class="social-container">
    
      
        <a href="https://github.com/jianhuchen" target="_blank">
          <i class="fab fa-github"></i>
        </a>
      
    
      
    
      
    
      
    
      
    
  </div>
</div>

        <div class="post-detail">
          <article class="post">
            <h2 class="post-title">
              LSTM+CTCè¯†åˆ«å˜é•¿éªŒè¯ç ï¼ˆäººå·¥æ™ºèƒ½ç¬¬4æ¬¡è¯•éªŒï¼‰
            </h2>
            <div class="post-info">
              <span>
                2018-11-21
              </span>
              <span>
                25 min read
              </span>
              
            </div>
            
            <div class="post-content-wrapper">
              <div class="post-content">
                <h1 id="1-å®éªŒé¢˜ç›®">1. å®éªŒé¢˜ç›®</h1>
<p><strong>åŸºäºRNNâ€”â€”LSTM+CTCçš„æ³¨å†Œç è¯†åˆ«å®éªŒ</strong></p>
<h1 id="2-å®éªŒè¿‡ç¨‹">2. å®éªŒè¿‡ç¨‹</h1>
<p>æœ¬æ¬¡å®éªŒä¸€å…±äº§ç”Ÿäº†ä¸‰ä¸ªæ–‡ä»¶</p>
<ul>
<li>**generate_verification_code.pyï¼š**ç”¨äºäº§ç”Ÿè®­ç»ƒé›†ã€éªŒè¯é›†ã€æµ‹è¯•é›†ï¼Œä¹Ÿå°±æ˜¯äº§ç”Ÿå¤§é‡éªŒè¯ç </li>
<li><strong>train_model.py</strong>ï¼šè®­ç»ƒæ¨¡å‹</li>
<li>**predict_test.pyï¼š**ç”¨è®­ç»ƒå¥½çš„æ¨¡å‹æ¥è¯†åˆ«æ–°è¾“å…¥çš„éªŒè¯ç </li>
</ul>
<h2 id="21-äº§ç”ŸéªŒè¯ç ">2.1 äº§ç”ŸéªŒè¯ç </h2>
<p>æœ¬æ¬¡å®éªŒäº§ç”ŸéªŒè¯ç çš„æ–¹æ³•ä¸ä¸Šæ¬¡ç›´æ¥ä½¿ç”¨captchaåº“äº§ç”ŸéªŒè¯ç çš„å®éªŒä¸åŒï¼Œæœ¬æ¬¡ä½¿ç”¨çš„æ˜¯freetypeçš„æ–¹æ³•ã€‚</p>
<p><strong>å¯¹åº”æ–‡ä»¶ï¼šgenerate_verification_code.pyï¼š</strong></p>
<h3 id="211-é¦–å…ˆå¯¼å…¥æ‰€éœ€è¦çš„åŒ…">2.1.1 é¦–å…ˆå¯¼å…¥æ‰€éœ€è¦çš„åŒ…</h3>
<pre><code class="language-python">import string
import numpy as np
import copy
import random
import cv2
import freetype
</code></pre>
<p>å…¶ä¸­ï¼š</p>
<ul>
<li>
<p>stringåœ¨äº§ç”ŸéªŒè¯ç å†…å®¹æ—¶ä¼šç”¨åˆ°ï¼Œç”¨å®ƒæ¥æ§åˆ¶äº§ç”Ÿçš„éªŒè¯ç åŒ…å«å“ªäº›å†…å®¹ï¼Œæ¯”å¦‚æ•°å­—ã€å¤§å†™å­—æ¯ã€å°å†™å­—æ¯</p>
</li>
<li>
<p>freetypeç”¨äºå¯¹ç»™å®šçš„å­—ç¬¦äº§ç”Ÿç›¸åº”çš„å›¾ç‰‡</p>
</li>
<li>
<p>cv2æ˜¯opencvåœ¨pythonä¸­åŒ…çš„åå­—ï¼Œæœ¬æ¬¡å®éªŒä¸ºäº†åŠ å¤§éš¾åº¦ï¼Œä½¿ç”¨freetypeäº§ç”Ÿå®Œä¸€å¼ éªŒè¯ç å›¾ç‰‡åï¼Œå¯ä»¥åœ¨è¿™å¼ å›¾ç‰‡çš„åŸºç¡€ä¹‹ä¸Šå†åŠ ä¸Šé«˜æ–¯å™ªå£°ï¼Œè¿™æ ·èƒ½åŠ å¤§å®éªŒæ¨¡å‹çš„è®­ç»ƒéš¾åº¦</p>
<p>å¤šæä¸€å¥ï¼Œå½“äº§ç”Ÿçš„éªŒè¯ç ä¸­æœ‰å™ªå£°æ—¶ï¼ŒåŒæ ·ä¹Ÿå¯ä»¥ä½¿ç”¨opencvçš„å‡å€¼æ¨¡ç³Šã€é«˜æ–¯æ¨¡ç³Šç­‰æ–¹æ³•æ¥é™ä½å™ªå£°ï¼Œæ€»ä¹‹ï¼Œopencvæ˜¯ä¸€ä¸ªéå¸¸å¼ºå¤§çš„è®¡ç®—æœºè§†è§‰åº“ï¼Œå®ƒèƒ½å¯¹å›¾ç‰‡åŠ å™ªï¼Œä¹Ÿèƒ½å»å™ª</p>
</li>
<li>
<p>randomåº“ç”¨äºäº§ç”Ÿéšæœºæ•°ï¼Œå› ä¸ºæœ¬å®éªŒè¦æ±‚éªŒè¯ç çš„é•¿åº¦æ˜¯ä¸ç¡®å®šçš„</p>
</li>
</ul>
<h3 id="212-å®šä¹‰put_chinese_textç±»">2.1.2 å®šä¹‰put_chinese_textç±»</h3>
<p><strong>put_chinese_textç±»</strong>ç”¨äºå°†æŸä¸€ä¸ªä¸²å­—ç¬¦â€œç”»â€åˆ°å›¾ä¸Šå»</p>
<pre><code class="language-python">class put_chinese_text(object):
	def __init__(self, ttf):
		self._face = freetype.Face(ttf)

	def draw_text(self, image, pos, text, text_size, text_color):
		self._face.set_char_size(text_size * 64)
		metrics = self._face.size
		ascender = metrics.ascender/64.0

		ypos = int(ascender)

		if not isinstance(text, str):
			text = text.decode('utf-8')
		img = self.draw_string(image, pos[0], pos[1]+ypos, text, text_color)
		return img

	def draw_string(self, img, x_pos, y_pos, text, color):
		prev_char = 0
		pen = freetype.Vector()
		pen.x = x_pos &lt;&lt; 6   # div 64
		pen.y = y_pos &lt;&lt; 6

		hscale = 1.0
		matrix = freetype.Matrix(int(hscale)*0x10000, int(0.2*0x10000),\
								 int(0.0*0x10000), int(1.1*0x10000))
		cur_pen = freetype.Vector()
		pen_translate = freetype.Vector()

		image = copy.deepcopy(img)
		for cur_char in text:
			self._face.set_transform(matrix, pen_translate)

			self._face.load_char(cur_char)
			kerning = self._face.get_kerning(prev_char, cur_char)
			pen.x += kerning.x
			slot = self._face.glyph
			bitmap = slot.bitmap

			cur_pen.x = pen.x
			cur_pen.y = pen.y - slot.bitmap_top * 64
			self.draw_ft_bitmap(image, bitmap, cur_pen, color)

			pen.x += slot.advance.x
			prev_char = cur_char

		return image

	def draw_ft_bitmap(self, img, bitmap, pen, color):
		x_pos = pen.x &gt;&gt; 6
		y_pos = pen.y &gt;&gt; 6
		cols = bitmap.width
		rows = bitmap.rows

		glyph_pixels = bitmap.buffer

		for row in range(rows):
			for col in range(cols):
				if glyph_pixels[row*cols + col] != 0:
					img[y_pos + row][x_pos + col][0] = color[0]
					img[y_pos + row][x_pos + col][1] = color[1]
					img[y_pos + row][x_pos + col][2] = color[2]
</code></pre>
<h3 id="213-å®šä¹‰generateverificationcodeç±»">2.1.3 å®šä¹‰generateVerificationCodeç±»</h3>
<p><strong>generateVerificationCodeç±»</strong>ç”¨äºäº§ç”ŸéªŒè¯ç ï¼Œå…·ä½“ä»£ç å¦‚ä¸‹</p>
<pre><code class="language-python">class generateVerificationCode(object):
	def __init__(self,
					width=256, # éªŒè¯ç å›¾ç‰‡çš„å®½
					height=32, # éªŒè¯ç å›¾ç‰‡çš„é«˜
					char_max_size=5, # éªŒè¯ç æœ€å¤šçš„å­—ç¬¦ä¸ªæ•°
					characters=string.digits):# + string.ascii_uppercase + string.ascii_lowercase):#éªŒè¯ç ç»„æˆï¼Œæ•°å­—+å¤§å†™å­—æ¯+å°å†™å­—æ¯
		self.width = width
		self.height = height
		self.char_max_size = char_max_size
		self.characters = characters
		self.classes = len(characters) # ä¸€å…±æœ‰å¤šå°‘ç±»
		self.char_set = list(self.characters)
		self.ft = put_chinese_text('fonts/OCR-B.ttf')

	def gen_verification_code(self, is_random=False, batch_size=50):
		X = np.zeros([batch_size, self.height, self.width, 3]) # 3ä¸ªé€šé“
		Y = np.zeros([batch_size, self.char_max_size, self.classes]) # one_hotç¼–ç 
		text_list=[]
		while True:
			for i in range(batch_size):
				# éšæœºè®¾å®šé•¿åº¦
				if is_random == True:
					size = random.randint(1, self.char_max_size)
				else:
					size = self.char_max_size
				# äº§ç”Ÿsizeé•¿åº¦çš„éšæœºä¸²
				text = ''.join(random.sample(self.characters, size))
				# ä¿å­˜æ‰€æœ‰strç±»å‹çš„label
				text_list.append(list(text))
				# äº§ç”Ÿä¸€å¼ å›¾ç‰‡
				img = np.zeros([self.height, self.width, 3]) # ä¸‰ä¸ªé€šé“
				color_ = (255,255,255) # Write
				pos = (0, 3)
				text_size = 25
				image = self.ft.draw_text(img, pos, text, text_size, color_)
				X[i] = np.reshape(image, [self.height, self.width, 3]) # /255.0  # å°†æ•°æ®å…¨éƒ¨å˜æ¢åˆ° [0,1] èŒƒå›´å†…
				for j, ch in enumerate(text):
					Y[i, j, self.characters.find(ch)] = 1
				# print(&quot;X.shape = &quot;, X.shape)
				# print(X)
				# print(&quot;text_list = &quot;, text_list)
				# print(&quot;Y.shape = &quot;, Y.shape)
				# print(Y)
			yield X, text_list, Y
</code></pre>
<p><strong>é¦–å…ˆçœ‹<code>__init__()</code>å‡½æ•°ï¼Œå®ƒä¸€å…±æœ‰5ä¸ªå‚æ•°ï¼Œåˆ†åˆ«å¦‚ä¸‹ï¼š</strong></p>
<ul>
<li>widthï¼šè®¾ç½®äº§ç”Ÿçš„éªŒè¯ç å›¾ç‰‡çš„å®½</li>
<li>heightï¼šè®¾ç½®äº§ç”Ÿçš„éªŒè¯ç å›¾ç‰‡çš„é«˜</li>
<li>char_max_sizeï¼šè®¾ç½®äº§ç”Ÿçš„éªŒè¯ç æœ€å¤šçš„å­—ç¬¦ä¸ªæ•°ï¼Œ æˆ‘è¿™é‡Œä¸ºäº†è®­ç»ƒé€Ÿåº¦å¿«ä¸€äº›è®¾æˆäº†5</li>
<li>charactersï¼šè®¾ç½®éªŒè¯ç ä¸­å­—ç¬¦ä¸²çš„ç»„æˆï¼Œæˆ‘çš„ä»£ç ä¸­è®¾ç½®åªäº§ç”Ÿäº†æ•°å­—ï¼Œå¯ä»¥è®²å®ƒæ”¹ä¸º<code>string.digits + string.ascii_uppercase + string.ascii_lowercase</code>ï¼Œè¿™æ ·å°±å¯ä»¥äº§ç”Ÿæ•°å­—ã€å¤§å†™å­—æ¯ã€å°å†™å­—æ¯æ··åˆçš„éªŒè¯ç </li>
</ul>
<p><strong>å†çœ‹<code>gen_verification_code()</code>å‡½æ•°ï¼Œå®ƒä¸€å…±æœ‰3å„å‚æ•°ï¼Œåˆ†åˆ«å¦‚ä¸‹ï¼š</strong></p>
<ul>
<li>is_randomï¼šè®¾ç½®éªŒè¯ç çš„é•¿åº¦æ˜¯å¦éšæœºï¼Œé»˜è®¤æ˜¯<code>False</code>ï¼Œæ­¤æ—¶äº§ç”Ÿçš„éªŒè¯ç ä¸ºå®šé•¿éªŒè¯ç ï¼Œé•¿åº¦ä¸º<code>char_max_size</code></li>
<li>batch_sizeï¼šè®¾ç½®ä¸€æ¬¡äº§ç”ŸéªŒè¯ç çš„å¼ æ•°ï¼Œä¾‹å¦‚äº§ç”Ÿä¸€ä¸ªbatchçš„è®­ç»ƒé›†æ—¶ï¼Œå¯ä»¥ç”¨äºæŒ‡å®šbatch_size</li>
</ul>
<p>éœ€è¦ç‰¹åˆ«è¯´æ˜çš„æ˜¯ï¼Œç¬¬31è¡Œä»£ç ä½¿ç”¨numpyäº§ç”Ÿä¸€ä¸ªshapeä¸º[height, width, 3]çš„çŸ©é˜µï¼Œç›¸å½“äºæ˜¯ç”Ÿæˆä¸€å¼ å›¾ç‰‡ï¼Œä½†å›¾ç‰‡ä¸Šä»€ä¹ˆä¿¡æ¯éƒ½æ²¡æœ‰ï¼Œå¾…ä¼šè°ƒç”¨<code>put_chinese_text</code>ç±»ä¸­çš„æ–¹æ³•æ¥å°†éšæœºå­—ç¬¦ä¸²<code>text</code>ä¸­çš„å†…å®¹â€œç”»â€ä¸Šå»</p>
<p><code>color_</code>å˜é‡ç”¨äºè®¾ç½®â€œç”»â€éªŒè¯ç æ—¶éªŒè¯ç ä¸Šçš„å­—ç¬¦é¢œè‰²ï¼Œæˆ‘è¿™é‡Œè®¾ç½®æˆç™½è‰²äº†ï¼Œ<code>pos</code>æ ‡é‡ç”¨äºè®¾ç½®â€œç”»â€éªŒè¯ç çš„èµ·ç‚¹ï¼Œ<code>text_size</code>ç”¨äºè®¾ç½®éªŒè¯ç ä¸­å­—ç¬¦çš„å­—ä½“å¤§å°</p>
<p>å‚æ•°è®¾ç½®å¥½åï¼Œå†è°ƒç”¨<code>put_chinese_text</code>ç±»ä¸­çš„<code>draw_text()</code>æ–¹æ³•æ¥â€œç”»â€éªŒè¯ç ï¼Œç”»å¥½ä¹‹åçš„å›¾èµ‹å€¼ç»™<code>image</code>å˜é‡</p>
<p><code>gen_verification_code()</code>å‡½æ•°æœ€åè¿”å›çš„å˜é‡ä¸€å…±ä¸‰ä¸ªï¼Œåˆ†åˆ«å¦‚ä¸‹ï¼š</p>
<ul>
<li>Xï¼šshape=[batch_size, width, height]ï¼Œäº§ç”Ÿçš„éªŒè¯ç çš„çŸ©é˜µå½¢å¼</li>
<li>text_listï¼šä¸€ä¸ªé•¿åº¦ä¸ºbatch_sizeçš„åˆ—è¡¨ï¼Œæ¯ä¸ªå…ƒç´ å¯¹åº”æ¯å¼ å›¾ç‰‡ä¸Šçš„å­—ç¬¦ä¸²</li>
<li>Yï¼šå®ƒä¸text_listçš„æ„ä¹‰ç›¸åŒï¼Œåªæ˜¯å½¢å¼ä¸åŒï¼Œå®ƒæ˜¯text_listçš„<code>one-hot</code>ç¼–ç å½¢å¼</li>
</ul>
<p><strong>æœ€åï¼Œæ¥æµ‹è¯•ä¸€ä¸‹å‡½æ•°çš„æ‰§è¡Œæƒ…å†µ</strong></p>
<p>ä¸ºäº†æ–¹ä¾¿æŸ¥çœ‹ï¼Œæˆ‘å°†<code>batch_size</code>è®¾ä¸º3ï¼Œå°†ä¸Šé¢ä»£ç çš„39-43è¡Œçš„æ‰“å°ä¿¡æ¯ä»£ç çš„æ³¨é‡Šæ‰“å¼€ï¼Œå†æ‰§è¡Œä¸‹æ–¹çš„ä»£ç </p>
<pre><code class="language-python">if __name__ == '__main__':
	genObj = generateVerificationCode()
	X, codes, Y = next(genObj.gen_verification_code(is_random=True, batch_size=3))
	for i in range(3):
		cv2.imshow(str(codes[i]), X[i])
	cv2.waitKey(0)
</code></pre>
<p>ä»£ç ä¸­çš„4-5è¡Œä½¿ç”¨opencvæ˜¾ç¤ºäº†éªŒè¯ç çš„å›¾åƒ</p>
<p>ç»“æœå¦‚ä¸‹ï¼š</p>
<img src=".\data_info.png" width="700px" title='data_info'/>
<img src=".\data_example.png" width="300px" title='data_example'/>
<p>é™¤æ­¤ä¹‹å¤–ï¼Œæˆ‘è¿˜å®šä¹‰äº†ä¸€ä¸ªç”Ÿæˆæµ‹è¯•é›†çš„<code>gen_test_verification_code()</code>å‡½æ•°ï¼Œå®ƒèƒ½å¤Ÿæ–¹ä¾¿çš„ç”Ÿæˆ100ï¼ˆé»˜è®¤ï¼‰å¼ å›¾ç‰‡ï¼Œä¿å­˜åœ¨ä½ æŒ‡å®šçš„ç›®å½•<code>dir</code>ä¸‹ï¼Œåœ¨åšæµ‹è¯•çš„æ—¶å€™å¯ä»¥ä½¿ç”¨opencvåº“è¯»å…¥ä»–ä»¬å¹¶å¯¼å…¥è®­ç»ƒå¥½çš„æ¨¡å‹æ¥åšæµ‹è¯•ï¼Œåé¢æµ‹è¯•æ¨¡å‹æ—¶ä¼šç”¨åˆ°ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<pre><code class="language-python">def gen_test_verification_code(self, dir, is_random=False, num=100):
	if not os.path.exists(dir):
		os.makedirs(dir)
	X = np.zeros([self.height, self.width, 3]) # 3ä¸ªé€šé“
	for i in range(num):
		# éšæœºè®¾å®šé•¿åº¦
		if is_random == True:
			size = random.randint(1, self.char_max_size)
		else:
			size = self.char_max_size
		# äº§ç”Ÿsizeé•¿åº¦çš„éšæœºä¸²
		text = ''.join(random.sample(self.characters, size))
		# äº§ç”Ÿä¸€å¼ å›¾ç‰‡
		img = np.zeros([self.height, self.width, 3]) # ä¸‰ä¸ªé€šé“
		color_ = (255,255,255) # Write
		pos = (0, 3)
		text_size = 25
		image = self.ft.draw_text(img, pos, text, text_size, color_)
		X = np.reshape(image, [self.height, self.width, 3]) # /255.0  # å°†æ•°æ®å…¨éƒ¨å˜æ¢åˆ° [0,1] èŒƒå›´å†…
		cv2.imwrite(dir+'/'+text+'.png', X[:, :, 2])
		print(&quot;\rGenerating.........(%d/%d)&quot;%(i+1, num), end='')	
	print(&quot;\nTest verification code generated.........&quot;)
</code></pre>
<h2 id="22-è®­ç»ƒæ¨¡å‹">2.2 è®­ç»ƒæ¨¡å‹</h2>
<p>æœ¬æ¬¡å®éªŒé‡‡ç”¨çš„ç½‘ç»œç»“æ„ä¸ºRNNï¼ˆå¾ªç¯ç¥ç»ç½‘ç»œï¼‰ä¸­çš„LSTMï¼ˆé•¿çŸ­æ—¶è®°å¿†ç½‘ç»œï¼‰ï¼Œé‡‡ç”¨CTCï¼ˆè”ç»“ä¸»ä¹‰æ—¶é—´åˆ†ç±»å™¨ ï¼ŒConnectionist Temporal Classifierï¼‰ä½œä¸ºæŸå¤±å‡½æ•°ï¼Œå®ƒé€‚åˆäºè¾“å…¥ç‰¹å¾å’Œè¾“å‡ºæ ‡ç­¾ä¹‹é—´å¯¹é½å…³ç³»ä¸ç¡®å®šçš„æ—¶é—´åºåˆ—é—®é¢˜ï¼ŒCTCå¯ä»¥è‡ªåŠ¨ç«¯åˆ°ç«¯åœ°åŒæ—¶ä¼˜åŒ–æ¨¡å‹å‚æ•°å’Œå¯¹é½åˆ‡åˆ†çš„è¾¹ç•Œã€‚</p>
<p><strong>å¯¹åº”æ–‡ä»¶ï¼štrain_model.py</strong></p>
<p>é¦–å…ˆå¯¼å…¥ç›¸å…³çš„åŒ…</p>
<pre><code class="language-python">from generate_verification_code import *
import numpy as np
import time 
import os
import tensorflow as tf
</code></pre>
<h3 id="221-å®šä¹‰ä¸€äº›è¶…å‚æ•°">2.2.1 å®šä¹‰ä¸€äº›è¶…å‚æ•°</h3>
<pre><code class="language-python">#å›¾ç‰‡å¤§å°ï¼Œ32 x 256
OUTPUT_SHAPE = (32,256)

# LSTM å¾ªç¯ä½“ä¸ªæ•°=64  å±‚æ•°=1
num_hidden = 64
num_layers = 1

obj = generateVerificationCode()
num_classes = obj.classes + 1 + 1  # 10ä½æ•°å­— + blank + ctc blank

#è®­ç»ƒæœ€å¤§è½®æ¬¡
num_epochs = 10000

#åˆå§‹åŒ–å­¦ä¹ é€Ÿç‡
INITIAL_LEARNING_RATE = 1e-3
DECAY_STEPS = 5000
REPORT_STEPS = 100
LEARNING_RATE_DECAY_FACTOR = 0.9  # The learning rate decay factor

DIGITS='0123456789'
BATCHES = 10
BATCH_SIZE = 64 
TRAIN_SIZE = BATCHES * BATCH_SIZE
</code></pre>
<p>è¿™äº›è¶…å‚æ•°åœ¨åé¢ç”¨åˆ°çš„æ—¶å€™ä¼šé™†é™†ç»­ç»­æåˆ°ï¼Œè¿™é‡Œå°±ä¸è¿‡å¤šè§£é‡Šäº†ï¼ŒæŠŠå®ƒæ”¾åœ¨è¿™é‡Œå†™æ˜¯å› ä¸ºè¿™äº›è¶…å‚æ•°ä¸€èˆ¬éƒ½æ”¾åœ¨æ–‡ä»¶çš„å¤´éƒ¨</p>
<h3 id="222-å…³äºctc_loss">2.2.2 å…³äºctc_loss</h3>
<p>ä¸Šé¢æåˆ°äº†æˆ‘ä»¬çš„æŸå¤±å‡½æ•°æ˜¯<code>ctc_loss</code>ï¼Œå®ƒåœ¨<a href="https://www.tensorflow.org/api_docs/python/tf/nn/ctc_loss">tensorflowä¸­çš„å®šä¹‰</a>å¦‚ä¸‹ï¼š</p>
<pre><code class="language-python">tf.nn.ctc_loss(
    labels,
    inputs,
    sequence_length,
    preprocess_collapse_repeated=False,
    ctc_merge_repeated=True,
    ignore_longer_outputs_than_inputs=False,
    time_major=True
)
</code></pre>
<ul>
<li>
<p><strong>labels</strong>: An <code>int32</code> <code>SparseTensor</code>ï¼Œç”¨æ¥ä¼ å…¥ä½ è®­ç»ƒæ•°æ®çš„çœŸå®å€¼ï¼Œè¦æ±‚æ˜¯int32ç±»å‹çš„<strong>ç¨€ç–çŸ©é˜µ</strong>ã€‚</p>
<blockquote>
<p>ç¨€ç–çŸ©é˜µï¼šåœ¨<strong>çŸ©é˜µ</strong>ä¸­ï¼Œè‹¥æ•°å€¼ä¸º0çš„å…ƒç´ æ•°ç›®è¿œè¿œå¤šäºé0å…ƒç´ çš„æ•°ç›®ï¼Œå¹¶ä¸”é0å…ƒç´ åˆ†å¸ƒæ²¡æœ‰è§„å¾‹æ—¶ï¼Œåˆ™ç§°è¯¥<strong>çŸ©é˜µ</strong>ä¸º<strong>ç¨€ç–çŸ©é˜µ</strong>ï¼›ä¸ä¹‹ç›¸åï¼Œè‹¥é0å…ƒç´ æ•°ç›®å å¤§å¤šæ•°æ—¶ï¼Œåˆ™ç§°è¯¥<strong>çŸ©é˜µ</strong>ä¸ºç¨ å¯†<strong>çŸ©é˜µ</strong>ã€‚ï¼ˆç™¾åº¦ç™¾ç§‘ï¼‰</p>
<p>ä¸€ä¸ªç¨€ç–çŸ©é˜µç”±ä¸‰ä¸ªè¦ç´ è¦ç¡®å®šï¼š</p>
<ul>
<li><code>indices</code>:äºŒç»´int64çš„çŸ©é˜µï¼Œä»£è¡¨é0çš„åæ ‡ç‚¹</li>
<li><code>values</code>:äºŒç»´tensorï¼Œä»£è¡¨indiceä½ç½®çš„æ•°æ®å€¼</li>
<li><code>dense_shape</code>:ä¸€ç»´ï¼Œä»£è¡¨ç¨€ç–çŸ©é˜µçš„å¤§å°</li>
</ul>
<p>ä¸¾ä¾‹ï¼š</p>
<p>æ‹¿ä¸Šé¢äº§ç”Ÿçš„ä¸‰å¼ éªŒè¯ç çš„å­—ç¬¦ä¸²'196'ã€â€˜76924â€™å’Œâ€˜58407â€™æ¥ä¸¾ä¾‹ï¼Œä»–ä»¬çš„<code>dense tensor</code>å½¢å¼å¦‚ä¸‹ï¼š</p>
<pre><code class="language-python">[[1,9,6,0,0]
 [7,6,9,2,4]
 [5,8,4,0,7]]
</code></pre>
<p>æŠŠä»–ä»¬è½¬æ¢æˆç³»æ•°çŸ©é˜µçš„å½¢å¼å°±åƒè¿™æ ·ï¼š</p>
<pre><code class="language-python">indecs = [[0,0],[0,1],[0,2],[1,0],[1,1],[1,2],[1,3],[1,4],[2,0],[2,1],[2,2],[2,3],[2,4]]
values = [1,9,6,7,6,9,2,4,5,8,4,0,7]
dense_shape = [3,5]
</code></pre>
</blockquote>
</li>
<li>
<p><strong>inputs</strong>: 3-D <code>float</code> <code>Tensor</code>ï¼Œç”¨æ¥ä¼ å…¥ä½ æ¨¡å‹é¢„æµ‹å‡ºçš„ç»“æœï¼Œè¦æ±‚æ˜¯ä¸€ä¸ªä¸‰ç»´floatå‹çš„æ•°æ®ç»“æ„</p>
<ul>
<li>
<p>å¦‚æœ <strong><code>time_major = False</code></strong>ï¼Œ<strong>inputs</strong>è¦æ±‚çš„å½¢çŠ¶ä¸º: <code>[batch_size, max_time, num_classes]</code>.</p>
</li>
<li>
<p>å¦‚æœ <strong><code>time_major = True (é»˜è®¤)</code></strong>ï¼Œ<strong>inputs</strong>è¦æ±‚çš„å½¢çŠ¶ä¸º: <code>[max_time, batch_size, num_classes]</code>.</p>
</li>
</ul>
</li>
<li>
<p><strong>sequence_length</strong>: 1-D <code>int32</code> vector, size <code>[batch_size]</code>.å®ƒè¡¨ç¤ºä¸€ä¸ªbatchä¸­æ¯ä¸ªè¾“å…¥LSTMç½‘ç»œçš„æ•°æ®çš„åºåˆ—çš„é•¿åº¦ï¼Œä¾‹å¦‚æœ¬å®éªŒä¸­éƒ½æ˜¯256</p>
<p>æ ¼å¼è¦æ±‚ï¼šä¸€ç»´int32ç±»å‹çš„å‘é‡ï¼Œå†…å®¹ä¸º[seq_len,â€¦,seq_len]ï¼Œé•¿åº¦ä¸ºbatch_size</p>
</li>
</ul>
<p><strong>äº†è§£å®Œctc_lossä¹‹åï¼Œå‘ç°éœ€è¦åšå¦‚ä¸‹å·¥ä½œï¼š</strong></p>
<ul>
<li>
<p><strong>ç¨€ç–çŸ©é˜µçš„ç¼–ç </strong></p>
<p>æˆ‘ä»¬ä¹‹å‰ä½¿ç”¨<strong>generateVerificationCodeç±»</strong>ä¸­ç”¨<strong>gen_verification_code()å‡½æ•°</strong>äº§ç”Ÿçš„æ•°æ®é›†ï¼Œå®ƒçš„è¿”å›å€¼ä¸­<code>text_list</code>æ˜¯<code>åºåˆ—åˆ—è¡¨</code>çš„å½¢å¼ï¼Œå¹¶ä¸æ˜¯<code>SparseTensor</code>çš„å½¢å¼ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦æœ‰å‡½æ•°æ¥å°†å®ƒè½¬æ¢æˆ<code>SparseTensor</code>å½¢å¼ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
</li>
</ul>
<pre><code class="language-python">#è½¬åŒ–ä¸€ä¸ªåºåˆ—åˆ—è¡¨ä¸ºç¨€ç–çŸ©é˜µ    
def sparse_tuple_from(sequences, dtype=np.int32):
	indices = []
	values = []
	for n, seq in enumerate(sequences):
		indices.extend(zip([n] * len(seq), range(len(seq))))
		values.extend(seq)
	indices = np.asarray(indices, dtype=np.int64)
	values = np.asarray(values, dtype=dtype)
	shape = np.asarray([len(sequences), np.asarray(indices).max(0)[1] + 1], dtype=np.int64)
	return indices, values, shape
</code></pre>
<ul>
<li>
<p><strong>ç³»æ•°çŸ©é˜µçš„è§£ç </strong></p>
<p><code>SparseTensor</code>å½¢å¼çš„æ•°æ®æ˜¯<code>ctc_loss</code>çš„è¦æ±‚ï¼Œè®²é¢„æµ‹å€¼ä¸çœŸå®å€¼é€è¿›<code>ctc_loss</code>åšæŸå¤±è®¡ç®—ï¼Œä½†æ˜¯æœ€åæˆ‘ä»¬åœ¨æµ‹è¯•é˜¶æ®µéœ€è¦çœ‹é¢„æµ‹çš„æ•°æ®å¯¹ä¸å¯¹ï¼Œè¿™æ—¶éœ€è¦å°†<code>SparseTensor</code>å½¢å¼çš„æ•°æ®è½¬æ¢å›å»ï¼ˆåºåˆ—åˆ—è¡¨ï¼‰ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
</li>
</ul>
<pre><code class="language-python">def decode_sparse_tensor(sparse_tensor):
	decoded_indexes = list()
	current_i = 0
	current_seq = []
	for offset, i_and_index in enumerate(sparse_tensor[0]):
		i = i_and_index[0]
		if i != current_i:
			decoded_indexes.append(current_seq)
			current_i = i
			current_seq = list()
		current_seq.append(offset)
	decoded_indexes.append(current_seq)
	result = []
	for index in decoded_indexes:
		result.append(decode_a_seq(index, sparse_tensor))
	return result
	
def decode_a_seq(indexes, spars_tensor):
	decoded = []
	for m in indexes:
		str = DIGITS[spars_tensor[1][m]]
		decoded.append(str)
	return decoded
</code></pre>
<h3 id="223-è®­ç»ƒæ•°æ®é›†çš„ç”Ÿæˆ">2.2.3 è®­ç»ƒæ•°æ®é›†çš„ç”Ÿæˆ</h3>
<p>å‰é¢å·²ç»æœ‰ç”ŸæˆéªŒè¯ç çš„å‡½æ•°äº†ï¼Œä¸ºä»€ä¹ˆè¿™é‡Œè¿˜è¦å†™ç”Ÿæˆè®­ç»ƒæ•°æ®é›†çš„å‡½æ•°å‘¢?</p>
<p>åŸå› å‰é¢å·²ç»è®¨è®ºåˆ°äº†ï¼Œå³ä½¿ç”¨**<code>generateVerificationCodeç±»</code><strong>ä¸­ç”¨</strong><code>gen_verification_code()å‡½æ•°</code>**äº§ç”Ÿçš„æ•°æ®é›†çš„<code>label</code>ï¼ˆæ ‡ç­¾ï¼‰å¹¶ä¸ç¬¦åˆ<code>ctc_loss</code>çš„æ ¼å¼è¦æ±‚ï¼Œä¸Šé¢ä¹Ÿåªæ˜¯å®šä¹‰äº†å¯ä»¥å°†<code>åºåˆ—åˆ—è¡¨</code>çš„å½¢å¼çš„æ ‡ç­¾è½¬æ¢æˆ<code>SparseTensor</code>çš„å½¢å¼æ ‡ç­¾çš„å‡½æ•°ï¼Œè¿˜æ²¡æœ‰è°ƒç”¨ï¼Œç°åœ¨åšçš„å·¥ä½œæ˜¯è°ƒç”¨ä¸Šé¢çš„å‡½æ•°æ¥ç”Ÿæˆæ•°æ®æ ¼å¼ç¬¦åˆ<code>ctc_loss</code>è¦æ±‚çš„è®­ç»ƒé›†ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<pre><code class="language-python"># ç”Ÿæˆä¸€ä¸ªè®­ç»ƒbatch
def get_next_batch(batch_size=128, is_random=True):
	obj = generateVerificationCode()
	# X.shape=[batch_size, height, width, 3]
	# è·å–ä¸€ä¸ªbatchçš„æ•°æ®é›†
	# codesä¸ºä¸€ä¸ªåˆ—è¡¨ï¼Œæ‰€æœ‰strç±»å‹çš„label
	X, text_list, Y = next(obj.gen_verification_code(is_random=is_random, batch_size=batch_size))
	# è¿™ä¸€æ­¥çš„ä½œç”¨ï¼šæ”¹å˜å½¢çŠ¶[batch_size, height, width, 1]=&gt;[batch_size, height, width]=&gt;[batch_size, width, height]
	X = np.transpose(np.reshape(X[:,:,:,2], [batch_size,OUTPUT_SHAPE[0],OUTPUT_SHAPE[1]]), (0, 2, 1))
	#targetsè½¬æˆç¨€ç–çŸ©é˜µ 
	# è¿”å›ä¸‰ä¸ªå€¼ï¼Œéé›¶å…ƒç´ çš„ä½ç½®ä¿¡æ¯ï¼Œéé›¶å…ƒç´ å¯¹åº”çš„å€¼ï¼Œç¨€ç–çŸ©é˜µçš„å½¢çŠ¶
	sparse_targets = sparse_tuple_from(text_list)
	#(batch_size,) sequence_lengthå€¼éƒ½æ˜¯256ï¼Œæœ€å¤§åˆ’åˆ†åˆ—æ•°
	seq_len = np.ones(X.shape[0]) * OUTPUT_SHAPE[1]
	return X, sparse_targets, seq_len 
</code></pre>
<p>è¿™ä¸ªå‡½æ•°çš„ç¬¬9è¡Œå°†éªŒè¯ç çš„é¢œè‰²å˜æˆäº†å•é€šé“ï¼ŒåŸå› ä¹Ÿæ˜¯æˆ‘å¸Œæœ›è®­ç»ƒé€Ÿåº¦èƒ½å¿«ä¸€äº›</p>
<p>å‡½æ•°é‡Œé¢æ¶‰åŠåˆ°äº†å¾ˆå¤šæ•°æ®æ ¼å¼çš„è½¬æ¢ï¼Œåœ¨æœ¬å®éªŒä¸­çš„æ€»ä½“çš„æ•°æ®æµå¦‚ä¸‹ï¼š</p>
<blockquote>
<p>gen_verification_code()---&gt;[batch_size, seq_len, num_features]</p>
<p>---&gt;LSTM---&gt;[batch_size, seq_len, cell.output_size]---&gt;reshape</p>
<p>---&gt;[batch_size*seq_len, num_hidden]---&gt;affine projection A*W+b</p>
<p>---&gt;[batch_size*seq_len, num_classes]---&gt;reshape</p>
<p>---&gt;[batch_size, seq_len, num_classes]---&gt;transpose</p>
<p>---&gt;[seq_len, batch_size, num_classes]</p>
</blockquote>
<p>è‡³äºä¸ºä»€ä¹ˆè¦åšè¿™ä¹ˆç¹ççš„æ•°æ®è½¬æ¢ï¼Œä¸‹é¢é©¬ä¸Šè¦æåˆ°å•¦</p>
<h3 id="224-å®šä¹‰lstmç½‘ç»œæ¨¡å‹">2.2.4 å®šä¹‰LSTMç½‘ç»œæ¨¡å‹</h3>
<p>æ•´ä½“çš„ç½‘ç»œç»“æ„æ˜¯ï¼šè¾“å…¥å•å…ƒâ€”&gt;64ä¸ªéšè—å•å…ƒï¼ˆå¾ªç¯ä½“ï¼‰â€”&gt;12ä¸ªè¾“å‡ºå•å…ƒ</p>
<p>æ‰€ä»¥åœ¨ç¬¬10è¡Œå°†å¾—åˆ°çš„LSTMè¾“å‡ºå€¼reshapeæˆ<code>[batch_size\*seq_len, num_hidden]</code>ä¹‹åï¼Œåˆç»§ç»­å°†ä»–ä»¬è¿æ¥åˆ°äº†è¾“å‡ºå±‚çš„12ä¸ªç¥ç»å…ƒï¼Œæœ€ç»ˆè¿”å›çš„logitsæ˜¯reshapeæˆ<code>[seq_len, batch_size, num_classes]</code>ä¹‹åçš„æ•°æ®</p>
<p><strong>ä¸ºä»€ä¹ˆè¦è¿™æ ·ä¸€ç›´reshapeï¼Ÿ</strong></p>
<p>å› ä¸ºè¿™ä¸ªè¿”å›çš„logiså³å°†è¦ä½œä¸º<code>inputs</code>æ•°æ®è¢«å–‚é€åˆ°<code>ctc_loss</code>é‡Œé¢å•¦ï¼Œä¸Šé¢å·²ç»å†™åˆ°äº†<code>ctc_loss</code>çš„<code>inputs</code>éœ€è¦<code>[max_time, batch_size, num_classes]</code>è¿™æ ·çš„æ•°æ®æ ¼å¼</p>
<p><strong>æ¶‰åŠåˆ°çš„è¶…å‚æ•°ï¼š</strong></p>
<ul>
<li>num_hidden = 64</li>
<li>num_layers = 1</li>
</ul>
<p>æ‰€ä»¥è¿™ä¸ªLSTMç½‘ç»œä¸­é—´å¾ªç¯ä½“çš„ä¸ªæ•°æ˜¯64ä¸ªï¼Œå±‚æ•°æ˜¯1</p>
<pre><code class="language-python">def RNN(inputs, seq_len):
	#å®šä¹‰LSTMç½‘ç»œ
	cell = tf.contrib.rnn.LSTMCell(num_hidden, state_is_tuple=True)
	stack = tf.contrib.rnn.MultiRNNCell([cell] * num_layers, state_is_tuple=True)
	#outputçš„shape=(64,256,64)(batch_size*256æ¡*64ä¸ªoutput)[batch_size,seq_len,cell.output_size]
	outputs, _ = tf.nn.dynamic_rnn(cell, inputs, seq_len, dtype=tf.float32)
	shape = tf.shape(inputs)
	batch_s, max_timesteps = shape[0], shape[1]
	# ä¸ºæ–¹ä¾¿çŸ©é˜µè¿ç®—ï¼Œreshapeä¸€ä¸‹outputsï¼Œoutputsçš„sizeæ˜¯(64*256,64)
	outputs = tf.reshape(outputs, [-1, num_hidden])
	# åˆå§‹åŒ–æƒå€¼  ç”Ÿæˆä¸€ä¸ªæˆªæ–­çš„æ­£æ€åˆ†å¸ƒ
	weights = tf.Variable(tf.truncated_normal([num_hidden, num_classes], stddev=0.1), name=&quot;W&quot;)
	bias = tf.Variable(tf.constant(0., shape=[num_classes]), name=&quot;b&quot;)
	# è®¡ç®—ç»“æœ
	# resultå½¢çŠ¶ï¼š[64*256, 12]
	logits = tf.matmul(outputs, weights) + bias
	# reshapeä¹‹ålogitsçš„shapeæ˜¯(64,256,12) [batch_size,seq_len,num_classes]
	logits = tf.reshape(logits, [tf.shape(inputs)[0], -1, num_classes])
	#äº¤æ¢åæ ‡è½´ï¼Œaxis0å’Œaxis1äº’æ¢ï¼Œlogitsçš„shapeæ˜¯(256,64,12) [seq_len,batch_size,num_classes]
	logits = tf.transpose(logits, (1, 0, 2))
	return logits
</code></pre>
<h3 id="225-å¼€å§‹è®­ç»ƒ">2.2.5 å¼€å§‹è®­ç»ƒ</h3>
<p>åœ¨å¼€å§‹è®­ç»ƒä¹‹å‰ï¼Œå…ˆå®šä¹‰ä¸€ä¸ªå‡½æ•°æ¥æ£€æµ‹å¾…ä¼šå„¿æ¨¡å‹é¢„æµ‹ç»“æœçš„æ­£ç¡®ç‡ï¼Œå¹¶ä¸”æ‰“å°å‡ºé¢„æµ‹çš„ç»“æœå’ŒçœŸå®çš„label</p>
<pre><code class="language-python">def do_report():
	test_inputs,test_targets,test_seq_len = get_next_batch(BATCH_SIZE)
	test_feed = {inputs: test_inputs, targets: test_targets, seq_len: test_seq_len}
	decoded_list, log_probs, accuracy = session.run([decoded[0], log_prob, acc], test_feed)
	
	original_list = decode_sparse_tensor(test_targets)
	detected_list = decode_sparse_tensor(decoded_list)

	true_numer = 0
	if len(original_list) != len(detected_list):
		print(&quot;len(original_list)&quot;, len(original_list), &quot;len(detected_list)&quot;, len(detected_list),
			  &quot; test and detect length desn't match&quot;)
		return -1
	print(&quot;T/F: original(length) &lt;-------&gt; detectcted(length)&quot;)
	for idx, number in enumerate(original_list):
		detect_number = detected_list[idx]
		hit = (number == detect_number)
		print(hit, number, &quot;(&quot;, len(number), &quot;) &lt;-------&gt; &quot;, detect_number, &quot;(&quot;, len(detect_number), &quot;)&quot;)
		if hit:
			true_numer = true_numer + 1
	Accuracy = true_numer * 1.0 / len(original_list)
	print(&quot;Test Accuracy:&quot;, Accuracy)
	return Accuracy
</code></pre>
<p>æ¥ä¸‹æ¥çœ‹å¼€å§‹å†™è®­ç»ƒçš„ä»£ç </p>
<p><strong>æ¶‰åŠåˆ°çš„è¶…å‚æ•°ï¼š</strong></p>
<ul>
<li>epochï¼šè®­ç»ƒçš„è½®æ•°ï¼Œç”±å‰é¢çš„<code>num_epochs = 10000</code>æ§åˆ¶ï¼Œè¡¨ç¤ºæœ€å¤šè®­ç»ƒ10000è½®</li>
<li>BATCHESï¼šè¡¨ç¤ºä¸€è½®è®­ç»ƒé‡Œbatchçš„æ•°é‡ï¼Œæœ¬å®éªŒä¸­æˆ‘è®¾ç½®çš„æ˜¯10</li>
<li>BATCH_SIZEï¼šè¡¨ç¤ºæ¯ä¸ªbatchä¸­çš„éªŒè¯ç ä¸ªæ•°</li>
<li>TRAIN_SIZEï¼šè¡¨ç¤ºä¸€ä¸ªepochè®­ç»ƒä¸‹æ¥ï¼Œä¸€å…±ä½¿ç”¨äº†å¤šå°‘å¼ éªŒè¯ç </li>
</ul>
<pre><code class="language-python">if __name__ == '__main__':
	# ç”¨æ¥è®°å½•å…¨å±€stepï¼Œæ¯æ›´æ–°ä¸€æ¬¡å‚æ•°å°±ä¼š+1
	global_step = tf.Variable(0, trainable=False)
	inputs = tf.placeholder(tf.float32, [None, OUTPUT_SHAPE[1], OUTPUT_SHAPE[0]])
	#targetsæ˜¯æ ‡ç­¾(ç¨€ç–çŸ©é˜µçš„å½¢å¼)ï¼Œå› ä¸ºå®šä¹‰ctc_losséœ€è¦çš„ç¨€ç–çŸ©é˜µ
	targets = tf.sparse_placeholder(tf.int32)
	#1ç»´å‘é‡ åºåˆ—é•¿åº¦ [batch_size,]
	#æ˜¯ä¸€ä¸ªé•¿åº¦=BATCH_SIZE=64çš„ä¸€ç»´å‘é‡,æ¯ä¸ªé‡Œé¢éƒ½æ˜¯256ï¼Œè¡¨ç¤ºä¸€ä¸ªbatchä¸­æ¯ä¸€å¼ æœ‰256æ¡è¾“å…¥åºåˆ—  
	seq_len = tf.placeholder(tf.int32, [None])
	# å®šä¹‰æŒ‡æ•°ä¸‹é™çš„å­¦ä¹ ç‡
	learning_rate = tf.train.exponential_decay(INITIAL_LEARNING_RATE, global_step, DECAY_STEPS, LEARNING_RATE_DECAY_FACTOR, staircase=True)
	# è°ƒç”¨å‰é¢å®šä¹‰å¥½çš„æ¨¡å‹ï¼Œå¹¶ä¼ å…¥å€¼
	logits = RNN(inputs, seq_len)
	# å®šä¹‰CTCæŸå¤±å‡½æ•° éœ€è¦å–‚å…¥æ•°æ®ï¼štargetsï¼Œlogitsï¼Œseq_len
	cost = tf.reduce_mean(tf.nn.ctc_loss(labels=targets, inputs=logits, sequence_length=seq_len))
	# ä½¿ç”¨AdamOptimizerè¿›è¡Œä¼˜åŒ–
	optimizer = tf.train.AdamOptimizer(learning_rate=learning_rate).minimize(cost, global_step=global_step)
	# è§£ç ï¼Œè·å¾—ç»“æœ
	decoded, log_prob = tf.nn.ctc_beam_search_decoder(logits, seq_len, merge_repeated=False)
	# æ±‚å‡†ç¡®ç‡
	acc = tf.reduce_mean(tf.edit_distance(tf.cast(decoded[0], tf.int32), targets))

	with tf.Session() as session:
		session.run(tf.global_variables_initializer())
		# è½½å…¥æ¨¡å‹
		saver = tf.train.Saver(tf.global_variables(), max_to_keep=3)
		ckpt_dir = &quot;./ckpt_dir&quot;
		if not os.path.exists(ckpt_dir):
			os.makedirs(ckpt_dir)
		ckpt = tf.train.get_checkpoint_state(ckpt_dir)
		if ckpt and ckpt.model_checkpoint_path:
			saver.restore(session, ckpt.model_checkpoint_path)
			print(&quot;Restore succcess! path:&quot;, ckpt.model_checkpoint_path)

		# å¼€å§‹è®­ç»ƒ
		# å®šä¹‰è®­ç»ƒç»“æŸçš„æ ‡å¿—ï¼Œå½“æ­£ç¡®ç‡è¾¾åˆ°æŸä¸€å€¼æ—¶ï¼Œå¯ä»¥é€šè¿‡è®¾ç½®å®ƒæ¥æå‰ç»“æŸè®­ç»ƒ
		train_end_flag = False
		start_time = time.time() # è®°å½•æ—¶é—´
		for curr_epoch in range(num_epochs):
			print(&quot;Epoch.......&quot;, curr_epoch)
			train_cost =  0
			for batch in range(BATCHES):
				b_start_time = time.time()
				# äº§ç”Ÿmini-batch=64çš„è®­ç»ƒé›†æ•°æ®
				train_inputs, train_targets, train_seq_len = get_next_batch(BATCH_SIZE)
				feed = {inputs: train_inputs, targets: train_targets, seq_len: train_seq_len}
				train_acc, _, b_cost, steps,  = session.run([acc, optimizer, cost, global_step], feed)
				train_cost += b_cost
				print(&quot;Step:&quot;, steps, &quot;, batch_time:&quot;, time.time()-b_start_time, 's')
				# æ¯REPORT_STEPSä¸ªstepæµ‹è¯•ä¸€ä¸‹æ­£ç¡®ç‡ï¼Œå¹¶æ‰“å°é¢„æµ‹ç»“æœå’ŒçœŸå®label
				if steps &gt; 0 and steps % REPORT_STEPS == 0:
					if(do_report()&gt;0.9):
						save_path = saver.save(session, ckpt_dir+&quot;/model.ckpt&quot;, global_step=steps)
						print(&quot;save succcess! path:&quot;, save_path)
						print(&quot;=============================&gt;Train succcess, Time:&quot;, time.time()-start_time, 's!')
						# å¦‚æœæ­£ç¡®ç‡è¶…è¿‡äº†0.9å°±å¯ä»¥æèµ·åœæ­¢è®­ç»ƒå•¦
						train_end_flag = True
						break
			# æå‰åœæ­¢è®­ç»ƒ            
			if train_end_flag:
				break
			# æ¯è¿‡ä¸€ä¸ªepochï¼Œè®¡ç®—ä¸€ä¸ªè®­ç»ƒè¯¯å·®
			train_cost /= BATCHES
			# æ¯è¿‡ä¸€ä¸ªepochï¼Œè°ƒç”¨ä¸€ä¸‹éªŒè¯é›†æµ‹è¯•
			val_inputs, val_targets, val_seq_len = get_next_batch(BATCH_SIZE)
			val_feed = {inputs: val_inputs,	targets: val_targets, seq_len: val_seq_len}
			val_cost, vald_acc, lr, steps = session.run([cost, acc, learning_rate, global_step], feed_dict=val_feed)
			log = &quot;Epoch {}/{}, steps = {}, train_cost = {:.3f}, val_cost = {:.3f}, time = {:.3f}s, learning_rate = {}&quot;
			print(log.format(curr_epoch + 1, num_epochs, steps, train_cost, val_cost, time.time()-b_start_time, lr))
</code></pre>
<h2 id="23-æµ‹è¯•æ¨¡å‹">2.3 æµ‹è¯•æ¨¡å‹</h2>
<p><strong>å¯¹åº”æ–‡ä»¶ï¼špredict_test.py</strong></p>
<p>é¦–å…ˆå¯¼å…¥ç›¸å…³çš„åŒ…</p>
<pre><code class="language-python"># é¦–å…ˆå¯¼å…¥éœ€è¦çš„åº“
import tensorflow as tf
import cv2
import sys
import os
from generate_verification_code import *
from train_model import *
</code></pre>
<p>è°ƒç”¨<code>gen_test_verification_code()</code>å‡½æ•°äº§ç”Ÿ100å¼ éªŒè¯ç </p>
<pre><code class="language-python"># è®¾ç½®äº§ç”Ÿæµ‹è¯•é›†æ–‡ä»¶å¤¹çš„åå­—
Testing_set_dir = 'TestingSet'
obj = generateVerificationCode()
# ç”ŸæˆéªŒè¯ç 
obj.gen_test_verification_code(Testing_set_dir, is_random=True, num=100)
</code></pre>
<p>ç”ŸæˆéªŒè¯ç åå¯ä»¥æ‰“å¼€<code>TestingSet</code>ç›®å½•æŸ¥çœ‹çœ‹ç”Ÿæˆçš„éªŒè¯ç </p>
<img src=".\testing_set.png" width="700px" title='testing_set'/>
<blockquote>
<p>è™½ç„¶å¸Œæœ›äº§ç”Ÿçš„æ˜¯100å¼ éªŒè¯ç ï¼Œä½†æ˜¯å¯èƒ½åœ¨äº§ç”Ÿçš„è¿‡ç¨‹ä¸­ä¼šæœ‰é‡åçš„æƒ…å†µï¼Œè¿™æ ·å°±æŠŠä¹‹å‰çš„éªŒè¯ç è¦†ç›–æ‰äº†ï¼Œæ‰€ä»¥æœ€ç»ˆäº§ç”Ÿçš„æµ‹è¯•é›†æ•°é‡å¯èƒ½ä¼šå°äº100</p>
</blockquote>
<p><code>gen_test_verification_code()</code>å‡½æ•°ç”Ÿæˆçš„éªŒè¯ç ä½¿ç”¨è¯¥éªŒè¯ç é‡Œé¢çš„å­—ç¬¦å‘½åï¼Œè¿™æ ·å¯ä»¥æ–¹ä¾¿è¯»å…¥éªŒè¯ç çš„æ—¶å€™ä¸€èµ·è¯»å…¥ä»–ä»¬çš„<code>label</code></p>
<p>ä¸‹æ–¹çš„ä»£ç æ˜¯ä½¿ç”¨<code>opencv</code>è¯»å…¥åˆšæ‰äº§ç”Ÿçš„éªŒè¯ç </p>
<pre><code class="language-python"># è·å–è¿™ä¸ªç›®å½•é‡Œçš„æ‰€æœ‰å›¾ç‰‡åå­—åˆ—è¡¨
file_list = os.listdir(Testing_set_dir) # è·å–æ­¤è·¯å¾„ä¸‹çš„æ‰€æœ‰æ–‡ä»¶çš„åå­—åˆ—è¡¨
# print(file_list)
# å°†100ä¸ªè®­ç»ƒæ ·æœ¬æ‰“åŒ…åˆ°test_x
test_x = np.zeros([len(file_list), obj.height, obj.width]) # 1ä¸ªé€šé“
text_list = []
for i, file in enumerate(file_list):
	image = cv2.imread(Testing_set_dir + '/' + file)
	gray_image = cv2.cvtColor(image, cv2.COLOR_BGR2GRAY)
	test_x[i] = gray_image
	text = list(file)[:-4] # remove '.png'
	text_list.append(text)
# [num, height, width]=&gt;[num, width, height]
test_x = np.transpose(test_x, (0, 2, 1)) 
test_targets = sparse_tuple_from(text_list)
test_seq_len = np.ones(test_x.shape[0]) * test_x.shape[1]
</code></pre>
<p>è·Ÿä¹‹å‰äº§ç”Ÿè®­ç»ƒé›†ä¸€æ ·ï¼Œéœ€è¦å¯¹è¯»å…¥çš„å›¾ç‰‡çš„æ•°æ®åšç›¸åº”çš„æ•°æ®å˜æ¢ï¼ˆ<code>opencv</code>è¯»å…¥åçš„æ•°æ®æ ¼å¼ä¸º<code>numpy</code>çš„<code>array</code>ï¼‰</p>
<p>æœ€åäº§ç”Ÿçš„æ•°æ®ä¿å­˜åœ¨<code>test_x</code>ã€<code>test_targets</code>å’Œ<code>test_seq_len</code>ä¸­</p>
<ul>
<li>test_xï¼šshape=[num, width, height]</li>
<li>test_targetsï¼šç¨€ç–çŸ©é˜µå½¢å¼çš„label</li>
<li>test_seq_lenï¼šLSTMç½‘ç»œçš„æ—¶é—´åºåˆ—é•¿åº¦ï¼Œä¹Ÿå°±æ˜¯æ¯å¼ å›¾ç‰‡çš„é•¿åº¦</li>
</ul>
<p>æµ‹è¯•æ•°æ®äº§ç”Ÿå®Œåï¼Œæ¥ä¸‹æ¥å¼€å§‹æµ‹è¯•è®­ç»ƒå¥½çš„æ¨¡å‹</p>
<pre><code class="language-python"># å®šä¹‰ä¸€äº›placeholderä½œä¸ºè¾“å…¥æ•°æ®çš„å…¥å£
inputs = tf.placeholder(tf.float32, [None, OUTPUT_SHAPE[1], OUTPUT_SHAPE[0]])
#targetsæ˜¯æ ‡ç­¾(ç¨€ç–çŸ©é˜µçš„å½¢å¼)ï¼Œå› ä¸ºå®šä¹‰ctc_losséœ€è¦çš„ç¨€ç–çŸ©é˜µ
targets = tf.sparse_placeholder(tf.int32)
#1ç»´å‘é‡ åºåˆ—é•¿åº¦ [batch_size,]
#æ˜¯ä¸€ä¸ªé•¿åº¦=BATCH_SIZE=64çš„ä¸€ç»´å‘é‡,æ¯ä¸ªé‡Œé¢éƒ½æ˜¯256ï¼Œè¡¨ç¤ºä¸€ä¸ªbatchä¸­æ¯ä¸€å¼ æœ‰256æ¡è¾“å…¥åºåˆ—  
seq_len = tf.placeholder(tf.int32, [None])
# è°ƒç”¨å‰é¢å®šä¹‰å¥½çš„æ¨¡å‹ï¼Œå¹¶ä¼ å…¥å€¼
logits = RNN(inputs, seq_len)
# è§£ç ï¼Œè·å¾—ç»“æœ
decoded, log_prob = tf.nn.ctc_beam_search_decoder(logits, seq_len, merge_repeated=False)
</code></pre>
<p>å®šä¹‰ä¼šè¯å¼€å§‹æµ‹è¯•</p>
<pre><code class="language-python">with tf.Session() as session:
	session.run(tf.global_variables_initializer())
	# è½½å…¥æ¨¡å‹
	saver = tf.train.Saver(tf.global_variables(), max_to_keep=3)
	ckpt_dir = &quot;./ckpt_dir&quot;
	if not os.path.exists(ckpt_dir):
		os.makedirs(ckpt_dir)
	ckpt = tf.train.get_checkpoint_state(ckpt_dir)
	if ckpt and ckpt.model_checkpoint_path:
		saver.restore(session, ckpt.model_checkpoint_path)
		print(&quot;Restore succcess! path:&quot;, ckpt.model_checkpoint_path)
	else:
		# å¦‚æœæ²¡æœ‰æ‰¾åˆ°ä¿å­˜çš„æ¨¡å‹å‚æ•°ï¼Œæ‰“å°å‡ºé”™ä¿¡æ¯
		print(&quot;Errorï¼šModel not found&quot;)

	# å¼€å§‹å–‚å…¥æµ‹è¯•æ•°æ®è¿›è¡Œé¢„æµ‹ï¼Œç»“æœä¿å­˜åˆ°pre_liståˆ—è¡¨ä¸­
	test_feed = {inputs: test_x, targets: test_targets, seq_len: test_seq_len}
	decoded_list = session.run(decoded[0], test_feed)
    # è§£ç å¹¶å¼€å§‹ä½œå¯¹æ¯”
	original_list = decode_sparse_tensor(test_targets)
	detected_list = decode_sparse_tensor(decoded_list)
	true_numer = 0
	if len(original_list) != len(detected_list):
		print(&quot;len(original_list)&quot;, len(original_list), &quot;len(detected_list)&quot;, len(detected_list),
			  &quot; test and detect length desn't match&quot;)
	print(&quot;T/F: original(length) &lt;-------&gt; detectcted(length)&quot;)
	for idx, number in enumerate(original_list):
		detect_number = detected_list[idx]
		hit = (number == detect_number)
		print(hit, number, &quot;(&quot;, len(number), &quot;) &lt;-------&gt; &quot;, detect_number, &quot;(&quot;, len(detect_number), &quot;)&quot;)
		if hit:
			true_numer = true_numer + 1
	Accuracy = true_numer * 1.0 / len(original_list)
	print(&quot;Test Accuracy:&quot;, Accuracy)
</code></pre>
<p>æˆ‘çš„æµ‹è¯•ç»“æœï¼š</p>
<pre><code class="language-python">Generating.........(100/100)
Test verification code generated
Restore succcess! path: ./ckpt_dir/model.ckpt-1900
T/F: original(length) &lt;-------&gt; detectcted(length)
True ['8', '4'] ( 2 ) &lt;-------&gt;  ['8', '4'] ( 2 )
True ['0', '9', '4', '3'] ( 4 ) &lt;-------&gt;  ['0', '9', '4', '3'] ( 4 )
True ['0'] ( 1 ) &lt;-------&gt;  ['0'] ( 1 )
True ['8', '2'] ( 2 ) &lt;-------&gt;  ['8', '2'] ( 2 )
True ['5', '0', '6', '4', '1'] ( 5 ) &lt;-------&gt;  ['5', '0', '6', '4', '1'] ( 5 )
...ï¼ˆçœç•¥ï¼‰
True ['1', '7', '8', '2', '4'] ( 5 ) &lt;-------&gt;  ['1', '7', '8', '2', '4'] ( 5 )
True ['0', '8', '1', '4', '9'] ( 5 ) &lt;-------&gt;  ['0', '8', '1', '4', '9'] ( 5 )
True ['1', '5'] ( 2 ) &lt;-------&gt;  ['1', '5'] ( 2 )
Test Accuracy: 1.0
</code></pre>
<h2 id="24-é‡åˆ°çš„é—®é¢˜">2.4 é‡åˆ°çš„é—®é¢˜</h2>
<p><strong>unicodeç¼–ç æŠ¥é”™ï¼š<code>NameError: name 'unicode' is not defined</code></strong></p>
<img src="./UnicodeErroro.jpg" width="400px" />
<p>**é”™è¯¯åŸå› ï¼š**åœ¨python3ä¸­æ‰ä¼šæŠ¥æ­¤é”™è¯¯ï¼Œæ‰€ä»¥åº”è¯¥æ˜¯ythonç‰ˆæœ¬ä¸å…¼å®¹æ‰€è‡´ï¼Œpython3å°†<code>unicode</code>æ”¹ä¸º<code>str</code>äº†</p>
<p>**è§£å†³åŠæ³•ï¼š**å¦‚æœä½ ä½¿ç”¨çš„æ˜¯python3ï¼Œå°†<code>unicode</code>æ”¹ä¸º<code>str</code>å³å¯è§£å†³</p>
<p><strong>å‚è€ƒèµ„æ–™ï¼š</strong></p>
<p><a href="https://www.tensorflow.org/api_docs/python/tf/nn/ctc_loss">Tensorflowå®˜ç½‘</a>(å¯èƒ½éœ€è¦ç§‘å­¦ä¸Šç½‘)</p>
<p>http://ilovin.me/2017-04-23/tensorflow-lstm-ctc-input-output/</p>
<p>https://www.jianshu.com/p/45828b18f133</p>
<p>https://github.com/jimmyleaf/ocr_tensorflow_cnn</p>

              </div>
              <div class="toc-container">
                <ul class="markdownIt-TOC">
<li><a href="#1-%E5%AE%9E%E9%AA%8C%E9%A2%98%E7%9B%AE">1. å®éªŒé¢˜ç›®</a></li>
<li><a href="#2-%E5%AE%9E%E9%AA%8C%E8%BF%87%E7%A8%8B">2. å®éªŒè¿‡ç¨‹</a>
<ul>
<li><a href="#21-%E4%BA%A7%E7%94%9F%E9%AA%8C%E8%AF%81%E7%A0%81">2.1 äº§ç”ŸéªŒè¯ç </a>
<ul>
<li><a href="#211-%E9%A6%96%E5%85%88%E5%AF%BC%E5%85%A5%E6%89%80%E9%9C%80%E8%A6%81%E7%9A%84%E5%8C%85">2.1.1 é¦–å…ˆå¯¼å…¥æ‰€éœ€è¦çš„åŒ…</a></li>
<li><a href="#212-%E5%AE%9A%E4%B9%89put_chinese_text%E7%B1%BB">2.1.2 å®šä¹‰put_chinese_textç±»</a></li>
<li><a href="#213-%E5%AE%9A%E4%B9%89generateverificationcode%E7%B1%BB">2.1.3 å®šä¹‰generateVerificationCodeç±»</a></li>
</ul>
</li>
<li><a href="#22-%E8%AE%AD%E7%BB%83%E6%A8%A1%E5%9E%8B">2.2 è®­ç»ƒæ¨¡å‹</a>
<ul>
<li><a href="#221-%E5%AE%9A%E4%B9%89%E4%B8%80%E4%BA%9B%E8%B6%85%E5%8F%82%E6%95%B0">2.2.1 å®šä¹‰ä¸€äº›è¶…å‚æ•°</a></li>
<li><a href="#222-%E5%85%B3%E4%BA%8Ectc_loss">2.2.2 å…³äºctc_loss</a></li>
<li><a href="#223-%E8%AE%AD%E7%BB%83%E6%95%B0%E6%8D%AE%E9%9B%86%E7%9A%84%E7%94%9F%E6%88%90">2.2.3 è®­ç»ƒæ•°æ®é›†çš„ç”Ÿæˆ</a></li>
<li><a href="#224-%E5%AE%9A%E4%B9%89lstm%E7%BD%91%E7%BB%9C%E6%A8%A1%E5%9E%8B">2.2.4 å®šä¹‰LSTMç½‘ç»œæ¨¡å‹</a></li>
<li><a href="#225-%E5%BC%80%E5%A7%8B%E8%AE%AD%E7%BB%83">2.2.5 å¼€å§‹è®­ç»ƒ</a></li>
</ul>
</li>
<li><a href="#23-%E6%B5%8B%E8%AF%95%E6%A8%A1%E5%9E%8B">2.3 æµ‹è¯•æ¨¡å‹</a></li>
<li><a href="#24-%E9%81%87%E5%88%B0%E7%9A%84%E9%97%AE%E9%A2%98">2.4 é‡åˆ°çš„é—®é¢˜</a></li>
</ul>
</li>
</ul>

              </div>
            </div>
          </article>
        </div>

        

        
          
            <link rel="stylesheet" href="https://unpkg.com/gitalk/dist/gitalk.css">
<script src="https://unpkg.com/gitalk/dist/gitalk.min.js"></script>

<div id="gitalk-container"></div>

<script>

  var gitalk = new Gitalk({
    clientID: '13244a83a82befebfcfd',
    clientSecret: 'c583df657426ac6aa4051674839478a647b5ae96',
    repo: 'jianhuchen-test.github.io',
    owner: 'jianhuchen-test',
    admin: ['jianhuchen-test'],
    id: (location.pathname).substring(0, 49),      // Ensure uniqueness and length less than 50
    distractionFreeMode: false  // Facebook-like distraction free mode
  })

  gitalk.render('gitalk-container')

</script>

          

          
        

        <div class="site-footer">
   | 
  <a class="rss" href="https://jianhuchen-test.github.io//atom.xml" target="_blank">RSS</a>
</div>

<script>
  hljs.initHighlightingOnLoad()

  let mainNavLinks = document.querySelectorAll(".markdownIt-TOC a");

  // This should probably be throttled.
  // Especially because it triggers during smooth scrolling.
  // https://lodash.com/docs/4.17.10#throttle
  // You could do like...
  // window.addEventListener("scroll", () => {
  //    _.throttle(doThatStuff, 100);
  // });
  // Only not doing it here to keep this Pen dependency-free.

  window.addEventListener("scroll", event => {
    let fromTop = window.scrollY;

    mainNavLinks.forEach((link, index) => {
      let section = document.getElementById(decodeURI(link.hash).substring(1));
      let nextSection = null
      if (mainNavLinks[index + 1]) {
        nextSection = document.getElementById(decodeURI(mainNavLinks[index + 1].hash).substring(1));
      }
      if (section.offsetTop <= fromTop) {
        if (nextSection) {
          if (nextSection.offsetTop > fromTop) {
            link.classList.add("current");
          } else {
            link.classList.remove("current");    
          }
        } else {
          link.classList.add("current");
        }
      } else {
        link.classList.remove("current");
      }
    });
  });

</script>

      </div>
    </div>
  </body>
</html>
